<!DOCTYPE HTML>
<html>
    <head><title>Medical Named Entity Visualizer · Explosion</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="referrer" content="always">
        <meta name="google-site-verification" content="g_Q1d9lRu0QfxU40-Y2oU9lZbWcXOkpN62Eb_1mTj94">
        <link rel="shortcut icon" href="https://explosion-demos.netlify.app/assets/img/favicon.ico">
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
        <link rel="stylesheet" href="https://explosion-demos.netlify.app/assets/css/style.css?v4.0">
        <link rel="stylesheet" href="https://explosion-demos.netlify.app/assets/css/demos.css?v2.0">
        <style type="text/css">
            [data-demo="displacy-ent"] [value="disease"]:checked+.d-input__option__value{background:#0bb}
            [data-demo="displacy-ent"] [value="cs"]:checked+.d-input__option__value{background:#ce0}
            [data-demo="displacy-ent"] [value="ms"]:checked+.d-input__option__value{background:#ce0}
            [data-demo="displacy-ent"] [value="dep"]:checked+.d-input__option__value{background:#bb0}
            [data-demo="displacy-ent"] [value="exam"]:checked+.d-input__option__value{background:#ff0}
            [data-demo="displacy-ent"] [value="cm"]:checked+.d-input__option__value{background:#aab}
            [data-demo="displacy-ent"] [value="wm"]:checked+.d-input__option__value{background:#aab}
            [data-demo="displacy-ent"] [value="organ"]:checked+.d-input__option__value{background:#4f77f4}
            [data-demo="displacy-ent"] [value="age"]:checked+.d-input__option__value{background:#40ff00}
            [data-demo="displacy-ent"] [value="sex"]:checked+.d-input__option__value{background:#1100ee}
            [data-demo="displacy-ent"] [value="cr"]:checked+.d-input__option__value{background:#40cc55}
        </style>
    </head>
<body>
    <main class="l-main">
    <div class="l-content"><article data-demo="displacy-ent">
    <header class="d-header d-wrapper l-wrapper">
        <h1 class="u-h3 u-b-sm">Medical Named Entity Visualizer</h1>
        <div><button style="width: 150px; background: #fff; color: #000" onclick="getSample(this)">start<button></div><br></br>
        <div class="u-t-md">
            <div class="d-input d-input--full">
                <span style="font-size: 12px">title</span><div class="d-input__wrapper">
                    <textarea id="title" rows="2" style="font-size: 14px" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span style="font-size: 12px">query</span><div class="d-input__wrapper">
                    <textarea id="query" rows="2" style="font-size: 14px" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span style="font-size: 12px">main_claim</span><div class="d-input__wrapper">
                    <textarea id="main_claim" rows="5" style="font-size: 14px" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span style="font-size: 12px">reply</span><div class="d-input__wrapper">
                    <textarea id="reply" rows="5" style="font-size: 14px" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
            <br></br>
            <div><label class="u-b-xs u-block u-h6">Medical Entity labels (<a class="u-a" onclick="selectAll(this)">select all</a>)</label>
                <label title="疾病" for="disease" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="disease" value="disease" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">DISEASE</span></label>
                <label title="中医描述的症状，如气虚等" for="cs" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="cs" value="cs" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">SYMPTOM(in Chinese medicine)</span></label>
                <label title="" for="ms" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="ms" value="ms" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">SYMPTOM(in modern medicine)</span></label>
                <label title="科室" for="dep" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="dep" value="dep" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">DEPARTMENT</span></label>
                <label title="检查" for="exam" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="exam" value="exam" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">EXAMINATION</span></label>
                <label title="中药" for="cm" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="cm" value="cm" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">CHINESE MEDICINE</span></label>
                <label title="西药" for="wm" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="wm" value="wm" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">WESTERN MEDICINE</span></label>
                <label title="器官" for="organ" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="organ" value="organ" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">ORGAN</span></label>
                <label title="年龄段" for="age" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="age" value="age" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">AGE</span></label>
                <label title="性别" for="sex" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="sex" value="sex" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">SEXUAL</span></label>
                <label title="特殊人群，如孕妇、易感人群等" for="cr" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="cr" value="cr" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">CROWD</span></label>
            </div>
            <div><label class="u-b-xs u-block u-h6">Entity labels(<a class="u-a" onclick="selectAll(this)">select all</a>)</label>
                <label title="People, including fictional." for="person" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="person" value="person" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">PERSON</span></label>
                <label title="Nationalities or religious or political groups." for="norp" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="norp" value="norp" class="d-input__option__box"> <span class="d-input__option__value">NORP</span></label>
                <label title="Buildings, airports, highways, bridges, etc." for="facility" class="d-input__option u-t-xs u-strong" style="display: none;"><input type="checkbox" id="facility" value="facility" class="d-input__option__box"> <span class="d-input__option__value">FACILITY</span></label>
                <label title="Companies, agencies, institutions, etc." for="org" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="org" value="org" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">ORG</span></label>
                <label title="Countries, cities, states." for="gpe" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="gpe" value="gpe" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">GPE</span></label>
                <label title="Non-GPE locations, mountain ranges, bodies of water." for="loc" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="loc" value="loc" class="d-input__option__box"> <span class="d-input__option__value">LOC</span></label>
                <label title="Objects, vehicles, foods, etc. (Not services.)" for="product" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="product" value="product" class="d-input__option__box"> <span class="d-input__option__value">PRODUCT</span></label>
                <label title="Named hurricanes, battles, wars, sports events, etc." for="event" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="event" value="event" class="d-input__option__box"> <span class="d-input__option__value">EVENT</span></label>
                <label title="Titles of books, songs, etc." for="work_of_art" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="work_of_art" value="work_of_art" class="d-input__option__box"> <span class="d-input__option__value">WORK OF ART</span></label>
                <label title="Any named language." for="language" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="language" value="language" class="d-input__option__box"> <span class="d-input__option__value">LANGUAGE</span></label>
                <label title="Absolute or relative dates or periods." for="date" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="date" value="date" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">DATE</span></label>
                <label title="Times smaller than a day." for="time" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="time" value="time" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">TIME</span></label>
                <label title="Percentage, including ”%“." for="percent" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="percent" value="percent" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">PERCENT</span></label>
                <label title="Monetary values, including unit." for="money" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="money" value="money" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">MONEY</span></label>
                <label title="Measurements, as of weight or distance." for="quantity" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="quantity" value="quantity" class="d-input__option__box" checked="checked"> <span class="d-input__option__value">QUANTITY</span></label>
                <label title="“first”, “second”, etc." for="ordinal" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="ordinal" value="ordinal" class="d-input__option__box"> <span class="d-input__option__value">ORDINAL</span></label>
                <label title="Numerals that do not fall under another type." for="cardinal" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="cardinal" value="cardinal" class="d-input__option__box"> <span class="d-input__option__value">CARDINAL</span></label>
                <label title="Named documents made into laws." for="law" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="law" value="law" class="d-input__option__box"> <span class="d-input__option__value">LAW</span></label>
            </div>
        </div>
    </header>
    
    <section class="d-content l-wrapper u-b-lg l-wrapper--page u-t-md">
        <h4>title</h4><div id="vis_title"></div><br></br>
        <h4>query</h4><div id="vis_query"></div><br></br>
        <h4>main_claim</h4><div id="vis_main_claim"></div><br></br>
        <h4>reply</h4><div id="vis_reply"></div><br></br>
    </section>
    </article></div>
    </main>
</body>

<script src="https://explosion-demos.netlify.app/assets/js/prism.js"></script>
<script src="https://explosion-demos.netlify.app/assets/js/vue.js"></script>
<script src="https://explosion-demos.netlify.app/js/displacy-ent.js"></script>
<script>
color = {
    "disease": "#0bb",
    "cs": "#ce0",
    "ms": "#ce0",
    "dep": "#bb0",
    "exam": "#ff0",
    "cm": "#aab",
    "wm": "#aab",
    "organ": "#4f77f4",
    "age": "#40ff00",
    "sex": "#1100ee",
    "cr": "#40cc55"
}

data_svr = "http://localhost:8008/";
function selectAll(element) {
    boxes = element.parentNode.parentNode.children;
    sig = false;
    for (i = 2; i < boxes.length; i++) {
        if (boxes[i].children[0].checked == false) {
            sig = true;
            break;
        }
    }
    for (i = 1; i < boxes.length; i++)
        boxes[i].children[0].checked = sig;
}

// --- global variables
try {
    var s = location.href;
    var username = s.split("?")[1].split("=")[1];
}
catch {
    alert("请先登录！");
    window.location.href = './login.html';
}

function format(data, anno) {
    title = data["title"];
    query = data["query"];
    main_claim = data["main_claim"];
    reply = data["reply"];

    document.getElementById("title").innerHTML = title;
    document.getElementById("query").innerHTML = query;
    document.getElementById("main_claim").innerHTML = main_claim;
    document.getElementById("reply").innerHTML = reply;

    for (var key in anno) {
        list = [];
        for (i = 0; i < data[key].length+1; i++)
            list.push("");
        for (i = 0; i < anno[key].length; i++) {
            start = anno[key][i][0][0];
            end = anno[key][i][0][1];
            type = anno[key][i][1];
            list[start] = list[start] + "<mark style=\"background: " + color[type] + "\" data-entity=\"" + type + "\">";
            list[end] = list[end] + "</mark>";
        }
        s = "";
        s = s + list[0];
        for (i = 0; i < data[key].length; i++) {
            s = s + data[key][i] + list[i+1];
        }
        document.getElementById("vis_" + key).innerHTML = s;
    }
}

var text = "";
var boundary = [];
var innerOut = [];

function getSample(element) {
    element.innerHTML = "Submit and Next";
    var xhr = new XMLHttpRequest();
    xhr.timeout = 5000;
    xhr.ontimeout = function(event){
        alert('请求超时！');
    }
    xhr.open("get", data_svr + "?action=1003&username=" + username, true);
    xhr.send();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            response = JSON.parse(xhr.responseText);
            if (response['errcode'] == 0) {
                // to do: enable multi-turn QA annotation (type=2)
                if (response['type'] == 1) {
                    format(response["data"],  response["anno"])
                } else {
                    pass;
                }
            } else {
                alert(response['errmsg']);
            }
        }
    };

    delete xhr;
}

var funcGetSelectText = function(id, flag) {
    var txt = document.getSelection();
    if (txt.anchorOffset >= txt.focusOffset) {
        left_side = txt.focusOffset;
        right_side = txt.anchorOffset;
    } else {
        left_side = txt.anchorOffset;
        right_side = txt.focusOffset;
    }
    if (flag == 0) {
        boundary.push([left_side, right_side]);
        innerOut.push([]); 
        return txt.toString();  
    } else if (flag == 1) {
        alert(innerOut, id);
        var offset = [left_side, right_side];
        lastInnerOut = innerOut[id];
        if (lastInnerOut.length > 0) {
            offset[0] += lastInnerOut[lastInnerOut.length - 1][1];
            offset[1] += lastInnerOut[lastInnerOut.length - 1][1];
        }
        innerOut[id].push(offset);
    }
}
    
function del(obj) {
    boundary[obj.parentNode.id] = [];
    innerOut[obj.parentNode.id] = [];
    element = event.srcElement;
    delNode = element.parentNode;
    rootNode = delNode.parentNode;
    rootNode.remove(delNode);
}

function assitant_annotation(text) {
    var result = new Array("疾病", "糖尿病");
    return result;
}

// to do 2
// read knowledge graph, and then,
// recommend some candidates for entity linking labelling
// write labelled result to database
function convert2BIEO() {
    var ques = document.getElementById("sample").innerText;
    var quesArr = [];
    for (let char of ques) {
        quesArr.push("O");
    }

    for (j=0; j<boundary.length; j++) {
        if (boundary[j].length == 0) {
            continue;
        }

        begin = boundary[j][0];
        end = boundary[j][1];
        quesArr[begin] = "B";
        quesArr[end-1] = "E";
        for (m=begin+1; m<end-1; m++) {
            quesArr[m] = "I";
        }
    }

    for (j=0; j<innerOut.length; j++) {
        if (innerOut[j].length == 0) {
            continue;
        }

        for (k=0; k<innerOut[j].length; k++) {
            begin = boundary[j][0] + innerOut[j][k][0];
            end = boundary[j][0] + innerOut[j][k][1];
            for (m=begin; m<end; m++) {
                if (quesArr[m] == "I") {
                    quesArr[m] = "o";
                }
            }
        }
    }

    console.log(quesArr);
    alert(ques + quesArr);
}

var container = container || document;
var index = 0;
container.onmouseup = function() {
    var srcElement = event.srcElement;
    if (srcElement.tagName == "T") {
        var txt = funcGetSelectText(0, 0);
        var form = document.getElementById("myForm");
        var item = document.createElement("item");
        form.appendChild(item);
        item.id = index;

        var li = document.createElement("li");
        item.appendChild(li);
        li.innerHTML = txt;
        li.appendChild(document.createTextNode(" "));
        var btn = document.createElement("button");
        btn.innerHTML = "X";
        btn.setAttribute("onclick", "del(this)");
        li.appendChild(btn);

        // to do 
        // get text
        // assitant_annotation(text);
        result = assitant_annotation(" ");
        entity_type = result[0];
        entity_norm = result[1];

        var li = document.createElement("li");
        li.style = "list-style-type: none;";
        li.id = "type" + index.toString();
        li.innerHTML = "实体类型（推荐）：" + entity_type;
        item.appendChild(li);

        // to do 1
        // generate attributes for differernt types of entities
        // for example, to a disease, annotates its period, and to a symptom, annotates its degree

        var li = document.createElement("li");
        li.style = "list-style-type: none;";
        li.id = "norm" + index.toString();
        li.innerHTML = "规范化实体（推荐）：" + entity_norm;
        item.appendChild(li);

        // to do
        // enable manual correction
        index += 1;
    }
    else if (srcElement.tagName == "LI") {
        funcGetSelectText(srcElement.id, 1);

        lastInnerOut = innerOut[srcElement.id];
        slice_index = 41 * (lastInnerOut.length - 1);

        var txt = srcElement.innerHTML;
        txt = txt.slice(0, slice_index + lastInnerOut[lastInnerOut.length - 1][0]) + '<small><font color="gray">' + txt.slice(slice_index + lastInnerOut[lastInnerOut.length - 1][0], slice_index + lastInnerOut[lastInnerOut.length - 1][1]) + "</font></small>" + txt.slice(slice_index + lastInnerOut[lastInnerOut.length - 1][1]);
        srcElement.innerHTML = txt;
    }
    else if (srcElement.tagName == "BUTTON" && srcElement.id == "submit") {
        convert2BIEO();
        boundary = [];
        innerOut = [];
        var center = document.getElementById("sample");
        center.innerHTML = "下一个";
    }
}
</script>
</html>