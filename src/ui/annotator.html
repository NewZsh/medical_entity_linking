<!DOCTYPE HTML>
<html>
    <head><title>Medical Named Entity Visualizer · Explosion</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="referrer" content="always">
        <meta name="google-site-verification" content="g_Q1d9lRu0QfxU40-Y2oU9lZbWcXOkpN62Eb_1mTj94">
        <link rel="shortcut icon" href="https://explosion-demos.netlify.app/assets/img/favicon.ico">
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
        <link rel="stylesheet" href="https://explosion-demos.netlify.app/assets/css/style.css?v4.0">
        <link rel="stylesheet" href="https://explosion-demos.netlify.app/assets/css/demos.css?v2.0">
    </head>
<body>
    <main class="l-main">
    <div class="l-content"><article data-demo="displacy-ent">
    <header class="d-header d-wrapper l-wrapper">
        <h1 class="u-h3 u-b-sm">Medical Named Entity Visualizer</h1>
        <div class="u-t-md">
            <div class="d-input d-input--full">
                <span>title</span><div class="d-input__wrapper">
                    <textarea id="title" rows="1" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span>query</span><div class="d-input__wrapper">
                    <textarea id="query" rows="1" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span>main_claim</span><div class="d-input__wrapper">
                    <textarea id="title" rows="1" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
                <span>reply</span><div class="d-input__wrapper">
                    <textarea id="title" rows="1" cols="15" placeholder="" onfocus="this.select()" class="d-input__field d-input__field--textarea"></textarea></div>
            <br></br>
            <div><label class="u-b-xs u-block u-h6">Entity labels (<a class="u-a" onclick="selectAll(this)">select all</a>)</label>
                <label title="People, including fictional." for="person" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="person" value="person" class="d-input__option__box"> <span class="d-input__option__value">PERSON</span></label>
                <label title="Nationalities or religious or political groups." for="norp" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="norp" value="norp" class="d-input__option__box"> <span class="d-input__option__value">NORP</span></label>
                <label title="Buildings, airports, highways, bridges, etc." for="facility" class="d-input__option u-t-xs u-strong" style="display: none;"><input type="checkbox" id="facility" value="facility" class="d-input__option__box"> <span class="d-input__option__value">FACILITY</span></label>
                <label title="Companies, agencies, institutions, etc." for="org" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="org" value="org" class="d-input__option__box"> <span class="d-input__option__value">ORG</span></label>
                <label title="Countries, cities, states." for="gpe" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="gpe" value="gpe" class="d-input__option__box"> <span class="d-input__option__value">GPE</span></label>
                <label title="Non-GPE locations, mountain ranges, bodies of water." for="loc" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="loc" value="loc" class="d-input__option__box"> <span class="d-input__option__value">LOC</span></label>
                <label title="Objects, vehicles, foods, etc. (Not services.)" for="product" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="product" value="product" class="d-input__option__box"> <span class="d-input__option__value">PRODUCT</span></label>
                <label title="Named hurricanes, battles, wars, sports events, etc." for="event" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="event" value="event" class="d-input__option__box"> <span class="d-input__option__value">EVENT</span></label>
                <label title="Titles of books, songs, etc." for="work_of_art" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="work_of_art" value="work_of_art" class="d-input__option__box"> <span class="d-input__option__value">WORK OF ART</span></label>
                <label title="Any named language." for="language" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="language" value="language" class="d-input__option__box"> <span class="d-input__option__value">LANGUAGE</span></label>
                <label title="Absolute or relative dates or periods." for="date" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="date" value="date" class="d-input__option__box"> <span class="d-input__option__value">DATE</span></label>
                <label title="Times smaller than a day." for="time" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="time" value="time" class="d-input__option__box"> <span class="d-input__option__value">TIME</span></label>
                <label title="Percentage, including ”%“." for="percent" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="percent" value="percent" class="d-input__option__box"> <span class="d-input__option__value">PERCENT</span></label>
                <label title="Monetary values, including unit." for="money" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="money" value="money" class="d-input__option__box"> <span class="d-input__option__value">MONEY</span></label>
                <label title="Measurements, as of weight or distance." for="quantity" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="quantity" value="quantity" class="d-input__option__box"> <span class="d-input__option__value">QUANTITY</span></label>
                <label title="“first”, “second”, etc." for="ordinal" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="ordinal" value="ordinal" class="d-input__option__box"> <span class="d-input__option__value">ORDINAL</span></label>
                <label title="Numerals that do not fall under another type." for="cardinal" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="cardinal" value="cardinal" class="d-input__option__box"> <span class="d-input__option__value">CARDINAL</span></label>
                <label title="Named documents made into laws." for="law" class="d-input__option u-t-xs u-strong" style=""><input type="checkbox" id="law" value="law" class="d-input__option__box"> <span class="d-input__option__value">LAW</span></label>
            </div>
    </header>
    
    <section class="d-content l-wrapper u-b-lg l-wrapper--page u-t-md"><div>When <mark data-entity="person">Sebastian Thrun</mark> started working on self-driving cars at <mark data-entity="org">Google</mark> in <mark data-entity="date">2007</mark>, few people outside of the company took him seriously. “I can tell you very senior CEOs of major <mark data-entity="norp">American</mark> car companies would shake my hand and turn away because I wasn’t worth talking to,” said <mark data-entity="gpe">Thrun</mark>, now the co-founder and CEO of online higher education startup Udacity, in an interview with Recode <mark data-entity="date">earlier this week</mark>.<br><br>A little <mark data-entity="date">less than a decade later</mark>, <mark data-entity="cardinal">dozens</mark> of self-driving startups have cropped up while automakers around the world clamor, wallet in hand, to secure their place in the fast-moving world of fully automated transportation.</div></section>
    </article></div></main></body>

<script src="https://explosion-demos.netlify.app/assets/js/prism.js"></script>
<script src="https://explosion-demos.netlify.app/assets/js/vue.js"></script>
<script src="https://explosion-demos.netlify.app/js/displacy-ent.js"></script>
<script>
data_svr = "http://localhost:8008/";

function selectAll(ele) {

}

// --- global variables
try {
    var s = location.href;
    var username = s.split("?")[1].split("=")[1];
}
catch {
    alert("请先登录！");
    window.location.href = './login.html';
}

var text = "";
var boundary = [];
var innerOut = [];
// --- end of global variables
if (document.getElementById("sample").innerText == "") {
    getSample();
}

/* get sample text from server
 */
function getSample() {
    var xhr = new XMLHttpRequest();
    xhr.timeout = 5000;
    xhr.ontimeout = function(event){
        alert('请求超时！');
    }
    xhr.open("get", data_svr + "?action=1003&username=" + username, true);
    xhr.send();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            response = JSON.parse(xhr.responseText);
            if (response['errcode'] == 0) {
                // to do: enable multi-turn QA annotation (type=2)
                if (response['type'] == 1) {
                    text = response["text"];
                    document.getElementById("sample").innerText = text;
                } else {
                    pass;
                }
            } else {
                alert(response['errmsg']);
            }
        }
    };

    delete xhr;
}

var funcGetSelectText = function(id, flag) {
    var txt = document.getSelection();
    if (txt.anchorOffset >= txt.focusOffset) {
        left_side = txt.focusOffset;
        right_side = txt.anchorOffset;
    } else {
        left_side = txt.anchorOffset;
        right_side = txt.focusOffset;
    }
    if (flag == 0) {
        boundary.push([left_side, right_side]);
        innerOut.push([]); 
        return txt.toString();  
    } else if (flag == 1) {
        alert(innerOut, id);
        var offset = [left_side, right_side];
        lastInnerOut = innerOut[id];
        if (lastInnerOut.length > 0) {
            offset[0] += lastInnerOut[lastInnerOut.length - 1][1];
            offset[1] += lastInnerOut[lastInnerOut.length - 1][1];
        }
        innerOut[id].push(offset);
    }
}
    
function del(obj) {
    boundary[obj.parentNode.id] = [];
    innerOut[obj.parentNode.id] = [];
    element = event.srcElement;
    delNode = element.parentNode;
    rootNode = delNode.parentNode;
    rootNode.remove(delNode);
}

function assitant_annotation(text) {
    var result = new Array("疾病", "糖尿病");
    return result;
}

// to do 2
// read knowledge graph, and then,
// recommend some candidates for entity linking labelling
// write labelled result to database
function convert2BIEO() {
    var ques = document.getElementById("sample").innerText;
    var quesArr = [];
    for (let char of ques) {
        quesArr.push("O");
    }

    for (j=0; j<boundary.length; j++) {
        if (boundary[j].length == 0) {
            continue;
        }

        begin = boundary[j][0];
        end = boundary[j][1];
        quesArr[begin] = "B";
        quesArr[end-1] = "E";
        for (m=begin+1; m<end-1; m++) {
            quesArr[m] = "I";
        }
    }

    for (j=0; j<innerOut.length; j++) {
        if (innerOut[j].length == 0) {
            continue;
        }

        for (k=0; k<innerOut[j].length; k++) {
            begin = boundary[j][0] + innerOut[j][k][0];
            end = boundary[j][0] + innerOut[j][k][1];
            for (m=begin; m<end; m++) {
                if (quesArr[m] == "I") {
                    quesArr[m] = "o";
                }
            }
        }
    }

    console.log(quesArr);
    alert(ques + quesArr);
}

var container = container || document;
var index = 0;
container.onmouseup = function() {
    var srcElement = event.srcElement;
    if (srcElement.tagName == "T") {
        var txt = funcGetSelectText(0, 0);
        var form = document.getElementById("myForm");
        var item = document.createElement("item");
        form.appendChild(item);
        item.id = index;

        var li = document.createElement("li");
        item.appendChild(li);
        li.innerHTML = txt;
        li.appendChild(document.createTextNode(" "));
        var btn = document.createElement("button");
        btn.innerHTML = "X";
        btn.setAttribute("onclick", "del(this)");
        li.appendChild(btn);

        // to do 
        // get text
        // assitant_annotation(text);
        result = assitant_annotation(" ");
        entity_type = result[0];
        entity_norm = result[1];

        var li = document.createElement("li");
        li.style = "list-style-type: none;";
        li.id = "type" + index.toString();
        li.innerHTML = "实体类型（推荐）：" + entity_type;
        item.appendChild(li);

        // to do 1
        // generate attributes for differernt types of entities
        // for example, to a disease, annotates its period, and to a symptom, annotates its degree

        var li = document.createElement("li");
        li.style = "list-style-type: none;";
        li.id = "norm" + index.toString();
        li.innerHTML = "规范化实体（推荐）：" + entity_norm;
        item.appendChild(li);

        // to do
        // enable manual correction
        index += 1;
    }
    else if (srcElement.tagName == "LI") {
        funcGetSelectText(srcElement.id, 1);

        lastInnerOut = innerOut[srcElement.id];
        slice_index = 41 * (lastInnerOut.length - 1);

        var txt = srcElement.innerHTML;
        txt = txt.slice(0, slice_index + lastInnerOut[lastInnerOut.length - 1][0]) + '<small><font color="gray">' + txt.slice(slice_index + lastInnerOut[lastInnerOut.length - 1][0], slice_index + lastInnerOut[lastInnerOut.length - 1][1]) + "</font></small>" + txt.slice(slice_index + lastInnerOut[lastInnerOut.length - 1][1]);
        srcElement.innerHTML = txt;
    }
    else if (srcElement.tagName == "BUTTON" && srcElement.id == "submit") {
        convert2BIEO();
        boundary = [];
        innerOut = [];
        var center = document.getElementById("sample");
        center.innerHTML = "下一个";
    }
}
</script>
</html>